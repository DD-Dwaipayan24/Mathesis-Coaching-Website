<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cashfree Payment</title>
  <style>
    body { font-family: Arial; background: #f5f5f5; display: flex; justify-content: center; align-items: center; height: 100vh; }
    .payment-container { background: #fff; padding: 30px; border-radius: 10px; width: 300px; }
    input, button { width: 100%; margin: 10px 0; padding: 10px; }
    button { background: #4CAF50; color: white; border: none; cursor: pointer; }
    button:hover { background: #45a049; }
  </style>

  <!-- ✅ Only this Razorpay SDK -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>

<div class="payment-container">
  <h2>Make a Payment</h2>
  <form id="paymentForm">
    <input type="text" id="name" placeholder="Full Name" required />
    <input type="email" id="email" placeholder="Email" required />
    <input type="text" id="phone" placeholder="Phone Number" required />
    <input type="number" id="coursePrice" placeholder="Amount (INR)" disabled />
    <input type="text" id="courseId" placeholder="Course ID" disabled />
    <button type="submit">Pay Now</button>
  </form>
</div>

<!-- ✅ Your JS (runs after SDK is loaded) -->
<script>
window.addEventListener("load", function () {
  const courseId = localStorage.getItem('selectedCourseId');
  const coursePrice = localStorage.getItem('selectedCoursePrice');
  if (courseId && coursePrice) {
    document.getElementById("courseId").value = courseId;
    document.getElementById("coursePrice").value = coursePrice;
  }

  document.getElementById("paymentForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const orderData = {
      orderId: "ORDER" + Date.now(),
      orderAmount: document.getElementById("coursePrice").value,
      customerName: document.getElementById("name").value,
      customerEmail: document.getElementById("email").value,
      customerPhone: document.getElementById("phone").value,
      courseId: document.getElementById("courseId").value,
    };

    // disable button to prevent double submits
    const submitBtn = e.target.querySelector('button[type="submit"]');
    if (submitBtn) submitBtn.disabled = true;

    try {
      const res = await fetch('/create-order', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          orderAmount: orderData.orderAmount,
          customerName: orderData.customerName,
          customerEmail: orderData.customerEmail,
          customerPhone: orderData.customerPhone,
          courseId: orderData.courseId
        }),
      });

      const data = await res.json();
      console.log('Server Response:', data);

       const options = {
        key: data.key,
        amount: data.amount * 100,
        currency: data.currency,
        name: "Coaching Institute",
        description: "Course Payment",
        order_id: data.orderId,
        handler: async function (response) {
          const verifyRes = await fetch("/verify-payment", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(response),
          });
          const verifyData = await verifyRes.json();
          if (verifyData.success) {
            alert("✅ Payment Successful!");
            // redirect to login page
            window.location.href = "/login.html"; 
          } else {
              alert("❌ Payment verification failed!");
          }
        },
      };
      
      // const Razorpay = require("razorpay");
      const rzp = new Razorpay(options);
      rzp.open();
    } catch (err) {
      console.error('Error creating order:', err);
      alert('Unable to create payment order. Please try again.');
    } finally {
      if (submitBtn) submitBtn.disabled = false;
    }
  });
});
</script>

</body>
</html>
